# åŸºäºMapReduceçš„ç»Ÿè®¡å»ºæ¨¡

## ä»€ä¹ˆä»»åŠ¡é€‚åˆä½¿ç”¨MapReduceï¼Ÿ

åŸºäºHadoopçš„MapReduceä¸»è¦ç”¨äºè¿›è¡Œæ•°æ®å¤„ç†(processing data)ï¼Œå¦‚å¯¹æ•°æ®è¿›è¡Œçš„åˆå§‹åŠ å·¥ï¼Œå¾—åˆ°åŸå§‹æ•°æ®åè¿›è¡Œå¿…è¦å˜é‡çš„å¯¼å‡ºï¼Œå¯¹æ•°æ®è¿›è¡Œå¿…è¦æ¸…ç†ï¼Œå¯¹æ–‡æœ¬æ•°æ®è¿›è¡Œæƒ…æ„Ÿçš„æ ‡æ³¨ï¼Œå¯¹å›¾åƒæ•°æ®è¿›è¡Œç®€å•çš„å›¾ç‰‡è¯†åˆ«ç­‰ã€‚é€‚åˆä½¿ç”¨MapReduceå®ç°çš„åŠŸèƒ½æœ‰ä»¥ä¸‹å‡ ç§ï¼š
æ’åº(Sorting)ã€‚MapReduceéå¸¸é€‚åˆè¿›è¡Œæ’åºå’Œå½’ç±»æ±‡æ€»ï¼Œå› ä¸ºMapReduceçš„è¿‡ç¨‹ä¸­å­˜åœ¨æ’åºæœºåˆ¶ï¼Œç»è¿‡mapè¿‡ç¨‹å¤„ç†åçš„æ•°æ®åœ¨è¿›å…¥åˆ°reduceè¿‡ç¨‹ä¹‹å‰ä¼šæ ¹æ®key/valueå¯¹ä¸­çš„keyå€¼è¿›è¡Œæ’åºï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æŒ‡å®šè¿›è¡Œæ’åºçš„ç‰¹å¾ã€‚
æœç´¢(Searching)ã€‚MapReduceé€‚åˆå¯¹å…¨éƒ¨æ•°æ®è¿›è¡Œæ‰«ææ€§å·¥ä½œï¼Œå¯»æ‰¾æ•°æ®çš„æŸäº›ç‰¹å¾ï¼Œå¦‚å¯»æ‰¾æŸäº›ç‰¹æ®Šçš„å­—ç¬¦ä¸²ï¼Œç»“æ„ï¼Œè¡¨è¾¾ç­‰ã€‚searchingè¿‡ç¨‹å¾€å¾€åœ¨mapperä¸­è¿›è¡Œï¼Œå¯ä»¥é€šè¿‡ç»“åˆPythonè¯­è¨€é‡Œçš„æ­£åˆ™è¡¨è¾¾ç­‰è¿›è¡Œå®ç°ã€‚searchingè¿‡ç¨‹ä¸ç»Ÿè®¡å¯†åˆ‡ç›¸å…³ï¼Œæ˜¯ä¼ ç»Ÿç»Ÿè®¡æ–¹æ³•å†…çš„åˆçº§çš„æ“ä½œï¼Œä½†éšç€æ•°æ®é‡çš„å¤§é‡å¢åŠ ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•å®ç°å¤§æ•°æ®å†…çš„searchingè¿‡ç¨‹ç¼ºä¹æ—¶æ•ˆæ€§ï¼Œåœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶å¾ˆéš¾å‘ç°æ•°æ®åº”æœ‰çš„ä»·å€¼ï¼Œè€ŒMapReduceèƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ã€‚
ç´¢å¼•(indexing)ã€‚indexingæŒ‡æ‰¾åˆ°æŸä¸€æ¨¡å—çš„å…·ä½“æ‰€åœ¨çš„ä½ç½®ï¼Œæœ€å¸¸è§çš„ä½¿ç”¨æ˜¯æœç´¢å¼•æ“å…¬å¸æ ¹æ®ç”¨æˆ·æä¾›çš„å…³é”®å­—å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„ç½‘é¡µã€‚
è‡ªç„¶è¯­è¨€å¤„ç†(NLP)ã€‚ç°ä»£æ•°æ®ä¸­å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯æ–‡æœ¬æ•°æ®ï¼Œå› æ­¤åœ¨å¤„ç†æ•°æ®è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°è‡ªç„¶è¯­è¨€å¤„ç†(NLP)ï¼Œå¦‚å¯¹æ–‡æœ¬æ•°æ®è¿›è¡Œæƒ…æ„Ÿæ ‡æ³¨ï¼Œå°†æ–‡æœ¬ä¿¡æ¯è¿ç”¨åœ¨å»ºæ¨¡ä¸­ï¼Œå°†æ–‡æœ¬ä¿¡æ¯è½¬åŒ–ä¸ºæ•°å€¼å‘é‡ç­‰ï¼Œå¸¸ç”¨çš„æ–‡æœ¬æ•°æ®å¤„ç†æ–¹æ³•æœ‰TFIDF, Word2Vec, doc2vecç­‰ã€‚

é™¤ä¸Šè¿°æåˆ°çš„å…·ä½“åŠŸèƒ½å¤–ï¼ŒMapReduceè¿˜é€‚åˆå¯¹æ‰€æœ‰çš„ç‹¬ç«‹æ•°æ®çš„å¤„ç†ï¼Œå¦‚æœè¿›è¡Œå¤§è§„æ¨¡çš„ç‹¬ç«‹æ€§æ•°æ®çš„æ“ä½œï¼ŒHadoopçš„MapReduceæ˜¯ä¸äºŒçš„é€‰æ‹©ï¼Œå› ä¸ºå…¶å…·æœ‰å»‰ä»·ä¸”å¤„ç†é€Ÿåº¦å¿«çš„ä¼˜åŠ¿ã€‚

## MapReduce-å®¹é”™

åœ¨å¤„ç†å¤§å‹æ•°æ®æ—¶ï¼Œæ•°æ®ä¸­æŸäº›è®°å½•å‡ºç°é”™è¯¯æ˜¯ä¸å¯é¿å…çš„ã€‚è™½ç„¶æˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºæ—¶ä¼šå°½å¯èƒ½çš„è€ƒè™‘åˆ°å¯èƒ½å‡ºé”™çš„æƒ…å†µå¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œä¿è¯ç¨‹åºçš„å¥å£®æ€§å’Œé²æ£’æ€§ï¼Œä½†è¿˜æ˜¯åº”è¯¥è®¾ç½®ä¸€ç§æ¢å¤æœºåˆ¶æ¥å¤„ç†æ— æ³•è®¡åˆ’çš„é”™è¯¯æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ä»…ä»…å› ä¸ºä¸€æ¡ç¨‹åºæ— æ³•å¤„ç†çš„ä¸è‰¯è®°å½•é€ æˆæ•´ä¸ªä»»åŠ¡çš„å¤±è´¥ã€‚

MapReduceçš„å®¹é”™æœºåˆ¶æŒ‡åœ¨ä»»åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœMapperä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼ŒMapperé¦–å…ˆä¼šé‡æ–°å°è¯•æ‰§è¡Œä¹Ÿå°±æ˜¯é‡å¤æ‰§è¡Œï¼Œä¸€èˆ¬é»˜è®¤é‡å¤æ‰§è¡Œ4æ¬¡åï¼Œå¦‚æœä»ç„¶æ‰§è¡Œå¤±è´¥å°±ä¼šæ”¾å¼ƒæ‰§è¡Œã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒMapReduceè¿˜å…·æœ‰ä¸€ç§æ¨æµ‹å¼æ‰§è¡Œæœºåˆ¶ï¼Œåœ¨è¿™ä¸ªæœºåˆ¶ä¸‹å¦‚æœæŸä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…å‡ºé¢„æœŸï¼ˆè¿™ä¸ªé¢„æœŸæ ¹æ®å…¶ä»–èŠ‚ç‚¹ä»»åŠ¡æ‰§è¡Œæ—¶é—´è€Œå®šï¼‰ï¼ŒMapReduceä¼šå¯åŠ¨å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œç›¸åŒä»»åŠ¡ï¼Œåœ¨æŸä¸ªèŠ‚ç‚¹ä»»åŠ¡æœ€å…ˆæ‰§è¡Œå®Œæˆä¹‹åæ€æ­»å…¶ä»–å°šæœªå®Œæˆçš„ä»»åŠ¡ã€‚æ¨æµ‹å¼æ‰§è¡Œæœºåˆ¶å¯ä»¥ä¿è¯æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½ä¼šå¼•å‘æŸäº›é—®é¢˜ï¼Œæ¨æµ‹å¼æ‰§è¡Œæœºåˆ¶æ˜¯å¯ä»¥å…³é—­çš„ã€‚

Hadoop MapReduceæä¾›äº†ä¸€é¡¹åŠŸèƒ½ï¼Œå…è®¸è·³è¿‡å®ƒè®¤ä¸ºä¼šå¯¼è‡´ä»»åŠ¡å´©æºƒçš„è®°å½•ã€‚MapReduceä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œå‡ºé”™èŠ‚ç‚¹å†…çš„TaskTrackerä¼šè·Ÿè¸ªå¹¶ç¡®å®šå¯¼è‡´å¤±è´¥çš„è®°å½•èŒƒå›´,ç„¶åTaskTrackerå°†é‡æ–°å¯åŠ¨ä»»åŠ¡ï¼Œä½†è·³è¿‡é”™è¯¯çš„è®°å½•èŒƒå›´ã€‚è‹¥è·³è¿‡é”™è¯¯è®°å½•èŒƒå›´åç¨‹åºæ‰§è¡ŒæˆåŠŸï¼Œæ‰§è¡Œç»“æœå°†è¿”å›é”™è¯¯è®°å½•ä¿¡æ¯ã€‚å…·ä½“æ“ä½œè¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨`JobConf`é€‰é¡¹ä¸­çš„`mapreduce.map.skip.maxrecords`å’Œ`mapreduce.reduce.skip.maxrecords`ä¸¤ä¸ªå‘½ä»¤åˆ†åˆ«è®¾ç½®mapå’Œreduceè¿‡ç¨‹ä¸­å…è®¸è·³è¿‡é”™è¯¯è®°å½•çš„æœ€å¤šæ¬¡æ•°ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒMapReduceè¿˜è®¾ç½®äº†å…¶ä»–é€‰é¡¹ï¼Œæ¯”å¦‚ä½¿ç”¨`mapreduce.map.maxattempts`å’Œ`mapreduce.reduce.maxattempts`è®¾ç½®é‡å¤æ‰§è¡Œçš„æœ€å¤šæ¬¡æ•°ç­‰ã€‚
å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½è¿‡åº¦ä¾èµ–MapReduceçš„å®¹é”™åŠŸèƒ½ï¼Œå› ä¸ºè¿™äº›åŠŸèƒ½æ˜¯åœ¨ç”¨æˆ·æ‰€å†™ç¨‹åºå……åˆ†è€ƒè™‘å„ç§é”™è¯¯æƒ…å†µä¸‹å¯¹æ— æ³•é¢„çŸ¥çš„é”™è¯¯è¿›è¡Œçš„å¤„ç†æœºåˆ¶ï¼Œç”¨æˆ·åœ¨ç¼–å†™ç¨‹åºæ—¶åº”å°½å¯èƒ½çš„å¯¹æ•°æ®çš„ä¸ç¡®å®šæ€§è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚åœ¨mapå’Œreduceå‡½æ•°çš„å†…éƒ¨æ·»åŠ å®¹é”™æœºåˆ¶ã€‚

ç¨‹åºä¸­åº”è¯¥è€ƒè™‘å®¹é”™çš„æƒ…å†µå¯èƒ½æœ‰ä»¥ä¸‹å‡ ç§ï¼šé¦–å…ˆï¼Œåœ¨ä½¿ç”¨Pythonæˆ–Rä¸­ç‰¹æ®Šçš„æ•°æ®ç»“æ„(æ¯”å¦‚Rä¸­çš„dataframeæˆ–Pythonä¸­çš„pandas)æ¥å¤„ç†æ•°æ®æ—¶ï¼Œå¤„ç†åçš„ç»“æœä¸­ä¼šå‡ºç°å¯¹åº”æ•°æ®ç»“æ„çš„ç‰¹æ®Šæ ‡è®°ï¼Œå¦‚æœæ²¡æœ‰å¯¹ç›¸åº”æ•°æ®æ ‡è®°è¿›è¡Œå¤„ç†ï¼Œå†æ¬¡å¤„ç†æ•°æ®æ—¶å°±ä¼šå‡ºç°æ•°æ®ä¸ç¬¦åˆè¦æ±‚çš„é—®é¢˜ã€‚å…¶æ¬¡ï¼ŒHadoopå‚¨å­˜æ•°æ®æ—¶ä¸å»ºè®®æ•°æ®æ·»åŠ è¡¨å¤´ï¼Œå› ä¸ºè¡¨å¤´åœ¨æ•°æ®å¤„ç†æ—¶ä¼šè¢«å½“åšä¸€è¡Œæ•°æ®è¿›è¡Œå¤„ç†ï¼Œå®¹æ˜“å¯¼è‡´ä»»åŠ¡è¿è¡Œå‡ºç°å¼‚å¸¸ã€‚åœ¨å­˜å‚¨æ•°æ®æ—¶å¯ä»¥å°†è¡¨å¤´å•ç‹¬å‚¨å­˜ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¾›ç”¨æˆ·ä½¿ç”¨æ—¶è¿›è¡Œå‚è€ƒã€‚å¦å¤–ï¼Œåœ¨ç¨‹åºç¼–å†™ä¸­è¦æ³¨æ„ä¸åŒè¯­è¨€çš„ç¼–ç ï¼Œé¿å…å› ä¸ºè¯­è¨€ç¼–ç çš„ä¸é€‚é…å¯¼è‡´ç¨‹åºè¿è¡Œä¸­å‡ºç°é”™è¯¯ã€‚


## ä½¿ç”¨MapReduceè¿›è¡Œçº¿æ€§å›å½’
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§å‹æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†ä½“é‡å·¨å¤§ï¼Œå ç”¨è®¡ç®—æœºçš„å¤§é‡å†…å­˜ï¼Œä¸”ç”¨ä¼ ç»Ÿå•æœºæ–¹å¼è¿›è¡Œçº¿æ€§å›å½’æ—¶éœ€è¦å¤§é‡æ—¶é—´ï¼Œç°åœ¨æˆ‘ä»¬å°†å¦‚ä½•å¯¹è¯¥å¤§å‹æ•°æ®é›†è¿›è¡Œå›å½’åˆ†æï¼Ÿ

é€šè¿‡ä½¿ç”¨Mapperå’ŒReducerï¼ŒHadoop MapReduceå¯ä»¥ç”¨äºå®ç°å¤§å‹æ•°æ®é›†çš„çº¿æ€§å›å½’ã€‚MapReduceå°†å¤§å‹æ•°æ®é›†æ‹†åˆ†æˆå¤šä¸ªæ•°æ®å—åˆ†å‘åˆ°å¯ç”¨èŠ‚ç‚¹ä¹‹ä¸Šï¼Œä½¿ç”¨èŠ‚ç‚¹å¹¶è¡Œå¤„ç†åˆ†å¸ƒå¼æ•°æ®ã€‚å½“æˆ‘ä»¬ä½¿ç”¨Hadoopè¿›è¡Œå¤§æ•°æ®é›†çš„çº¿æ€§å›å½’è¿ç®—æ—¶ä¸ä¼šå¼•å‘å†…å­˜é—®é¢˜ï¼Œå› ä¸ºè¯¥å¤§å‹æ•°æ®é›†å°†åœ¨Hadoopè®¡ç®—èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œåˆ†å‘å’Œå¤„ç†ï¼Œä¸”èƒ½å¤Ÿå¤§å¤§ç¼©çŸ­å¤„ç†æ•°æ®æ‰€ç”¨æ—¶é—´ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•å®ç°çš„çº¿æ€§å›å½’ä¸èƒ½æä¾›æ¯”`lm()`æ¨¡å‹æ›´é«˜çš„é¢„æµ‹ç²¾åº¦ï¼Œå…¶ç²¾åº¦ä¸ä¼ ç»Ÿæ–¹æ³•ç›¸åŒã€‚

### çº¿æ€§å›å½’æ¨¡å‹å›é¡¾
å‡è®¾å¾…å¤„ç†çš„æ•°æ®é›†ä¸­åŒ…å«å› å˜é‡$y_{n\times 1}$ä¸è‡ªå˜é‡$X_{n\times p}$ï¼Œå¯¹æ•°æ®æ„å»ºçº¿æ€§å›å½’æ¨¡å‹å¦‚ä¸‹ï¼š$$y=X\beta +\epsilon$$
å¾…ä¼°ç³»æ•°$\widehat \beta$çš„è§£æè§£ä¸ºï¼š$$\widehat\beta = (X'X)^{-1}X'y$$
è¿›è¡Œçº¿æ€§å›å½’æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ±‚å‡ºå¾…ä¼°ç³»æ•°$\widehat \beta$ã€‚
åœ¨å¤§å‹æ•°æ®é›†çš„çº¿æ€§å›å½’ä¸­ï¼Œç”±äº$n>>p$ï¼Œåœ¨è®¡ç®—$X'X$å’Œ$X'y$ æ—¶éœ€è¦éå¸¸é«˜çš„è®¡ç®—éœ€æ±‚ï¼Œå¯¹æ™®é€šè®¡ç®—æœºæ¥è¯´éš¾ä»¥åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å®ç°ã€‚è€Œä¸Šè¿°è®¡ç®—çš„ç»“æœ$(X'X)_{p\times p}$å’Œ $(X'y)_{p\times 1}$ä¹‹é—´è¿›è¡Œè®¡ç®—çš„è®¡ç®—é‡å°ï¼Œåœ¨æ™®é€šè®¡ç®—æœºä¸Šä¹Ÿå¯ä»¥è½»æ˜“å®Œæˆã€‚å› æ­¤ï¼Œè®¡ç®—$\widehat \beta$çš„æœ€ä¸»è¦é—®é¢˜æ˜¯$X'X$å’Œ$X'y$çš„è®¡ç®—ï¼Œè€Œä¸Šè¿°è®¡ç®—å¯ä»¥ä½¿ç”¨MapReduceå®ç°ã€‚

ä½¿ç”¨MapReduceè¿›è¡Œçº¿æ€§å›å½’æ˜¯ç›¸å¯¹å®¹æ˜“çš„ï¼Œå› ä¸ºå¾…ä¼°ç³»æ•°$\widehat \beta$å…·æœ‰è§£æè§£ï¼Œåªéœ€ä½¿ç”¨MapReduceå°†è§£æè§£æ±‚å‡ºå³å¯ã€‚å¯¹äºå¾…ä¼°ç³»æ•°æ²¡æœ‰è§£æè§£çš„å…¶ä»–æ¨¡å‹(å¦‚ä¸‹é¢å°†ä»‹ç»çš„logisticå›å½’æ¨¡å‹)ï¼Œä½¿ç”¨MapReduceæ±‚è§£è¾ƒä¸ºå¤æ‚ã€‚

### çº¿æ€§å›å½’æ¨¡å‹çš„MapReduceå®ç°åŸç†

é¦–å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾å¾…å¤„ç†çš„æ•°æ®é›†ä¸­åŒ…å«å› å˜é‡$y_{n\times 1}$ä¸è‡ªå˜é‡$X_{n\times 1}$ï¼Œ$X'y$çš„è®¡ç®—å¯ä»¥å†™ä½œï¼š $$X'y = \begin{bmatrix}
          x_{1.}\\
          x_{2.}\\
          ...\\
          x_{k.}\\
        \end{bmatrix}'
        \begin{bmatrix}
          y_{1.}\\
          y_{2.}\\
          ...\\
          y_ {k.}\\
        \end{bmatrix} = \sum_{i=1}^k x_{i.}'y_{i.}$$
å…¶ä¸­ï¼Œkæ˜¯æŒ‡nè¡Œæ•°æ®è¢«åˆ†æˆäº†kä»½ï¼Œåœ¨MapReduceçš„è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œæ¯ä»½æ•°æ®å°†è¢«åˆ†é…åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¡ç®—ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ä½¿ç”¨MapReduceè¿›è¡Œ$X'y$è®¡ç®—æ—¶ï¼Œæœ€ç»ˆç»“æœä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„$x_{i.}'y_{i.}$çš„è®¡ç®—ç»“æœçš„å’Œã€‚å› æ­¤ï¼Œè®¾è®¡ç¨‹åºä½¿mapè¿‡ç¨‹è¿›è¡Œä¸åŒæ•°æ®å—çš„$x_{i.}'y_{i.}$è®¡ç®—ï¼Œreduceè¿‡ç¨‹è¿›è¡Œæ±‚å’Œè®¡ç®—ï¼Œå³å¯è®¡ç®—å‡º$X'y$çš„å€¼ã€‚å½“è‡ªå˜é‡ä¸º$X_{n\times p}$æ—¶ï¼Œè®¡ç®—çš„æ€è·¯ç›¸åŒã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§åŒæ ·çš„æ–¹æ³•è¿›è¡Œ$X'X$çš„è®¡ç®—ã€‚å°†$X$çš„æ¯ä¸€åˆ—çœ‹åšä¸€ä¸ªå‘é‡ï¼Œ$X'X$çš„è®¡ç®—è¿‡ç¨‹å³å¯è½¬åŒ–ä¸ºå¤šä¸ª$X'$ä¸$x_{.i}$çš„ä¹˜ç§¯è®¡ç®—ï¼Œå¦‚ä¸‹å¼æ‰€ç¤ºï¼š
$$ X'X = X'
        \begin{bmatrix}
          x_{.1}&x_{.2}&...& x_ {.p}\\
        \end{bmatrix} = \begin{bmatrix}
          X'x_{.1}&X'x_{.2}&...& X'x_ {.p}\\
        \end{bmatrix}$$
è€Œ$X'x_{.i}$çš„è®¡ç®—æ–¹æ³•ä¸$X'y$çš„è®¡ç®—æ–¹æ³•å®Œå…¨ç›¸åŒã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨MapReduceå®ç°$X'X$å’Œ$X'y$çš„è®¡ç®—.

### æ¡ˆä¾‹ï¼šçº¿æ€§å›å½’æ¨¡å‹çš„MapReduceå®ç°

ä½¿ç”¨MapReduceè¿›è¡Œå¤§é‡æ•°æ®çš„çº¿æ€§å›å½’ã€‚è¿›è¡Œçº¿æ€§å›å½’çš„æ•°æ®ä¸­è‡ªå˜é‡ä¸ªæ•°ä¸º$p$ï¼Œæ•°æ®é‡ä¸º$n$ï¼Œä¸”æ»¡è¶³$n>>p$ã€‚
æ ¹æ®å¤šå…ƒå›å½’åŸç†å…¬å¼ï¼Œå°†è®¡ç®—å›å½’ç³»æ•°å…¬å¼åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ$X'y$éƒ¨åˆ†å’Œ$X'X$è®¡ç®—éƒ¨åˆ†ï¼Œåœ¨mapperä¸Šè®¡ç®—ä¸¤ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆ$X'y$è®¡ç®—æ˜¯æŒ‰è¡Œåˆ†å‰²ååœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè®¡ç®—$(x_{i1}y_i,x_{i2}y_i,...,x_{ip}y_i)$ã€‚å¯¹äº$X'X$éƒ¨åˆ†ï¼Œ$X$è¢«åˆ†æˆ$p$ä¸ªåˆ—å‘é‡åˆ†åˆ«ä¸$X'$è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—æ–¹å¼ä¸$X'y$ç›¸åŒã€‚å°†æ¯ä¸ªèŠ‚ç‚¹ä¸¤ä¸ªéƒ¨åˆ†è®¡ç®—ç»“æœåˆå¹¶æˆä¸€è¡Œï¼Œå…ˆåœ¨æ¯ä¸ªèŠ‚ç‚¹å°†æ‰€æœ‰å‘é‡ç›¸åŠ ï¼Œå†è¿›è¡Œæµè¾“å‡ºåˆ°reducerä¸­ï¼Œè¿›è¡ŒåŠ æ€»åˆå¹¶ï¼Œå¹¶é‡æ–°æ¢å¤æˆçŸ©é˜µï¼Œè®¡ç®—betaã€‚
è®¡ç®—è¿‡ç¨‹çš„ä»£ç å®ç°å¦‚ä¸‹ï¼Œä»£ç ç”±pythonå®ç°ã€‚
mapè¿‡ç¨‹ï¼š

       #! /usr/bin/python3
       
       import sys
       import numpy as np
       
       lenline = 0
       for line in sys.stdin:
           line = line.strip()
           line = line.split(',')
           if lenline == 0:
               lenline = len(line)
               sumtrx = np.zeros(lenline*(lenline+1))
           arr1 = np.asarray(line, dtype=float)
           arr2 = np.asarray(line[1: ], dtype=float)
           arr1 = np.insert(arr1, 1, 1).reshape(lenline+1, 1)
           arr2 = np.insert(arr2, 0, 1).reshape(1, lenline)
           mtrx = arr1.dot(arr2)
           mtrx = mtrx.flat
           sumtrx = sumtrx + mtrx
       print(list(sumtrx))

reduceè¿‡ç¨‹ï¼š

       #! /usr/bin/python3
       
       import sys
       import numpy as np

       length = 0
       for line in sys.stdin:
           line = line.strip()
           line = line.strip('[]')
           line = line.split(',')
           if length == 0:
               length = len(line)
               suml = np.zeros(length)
           line = np.asarray(line, dtype= float)
           suml = suml +line
       
       suml = np.asarray(suml)
       n = int((4*length)**0.5/2)
       if (n+1)*n != length:
           stop('length of the input is not true')
       summtrx = suml.reshape(n+1, n)
       [xy, xx] = np.split(summtrx, [1, ], axis=0)

       beta = np.dot(np.linalg.inv(xx), xy.transpose())
       print(beta.reshape(1, len(beta)))

åœ¨ä½¿ç”¨ä¸Šè¿°ä»£ç è¿›è¡Œæ±‚è§£çš„è¿‡ç¨‹ä¸­ï¼Œè‹¥è®¾ç½®å¤šä¸ªreduceä»»åŠ¡ï¼Œæ±‚å‡ºçš„betaå€¼å¯èƒ½ä¼šæœ‰å¤šç»„ï¼Œè¿™æ—¶å¯èƒ½éœ€è¦é€šè¿‡åœ¨æœ¬åœ°æ±‚å¹³å‡ç­‰æ–¹å¼å¯¹å…¶è¿›è¡Œå¤„ç†å¾—åˆ°æœ€ç»ˆçš„betaç»“æœã€‚

## ä½¿ç”¨MapReduceè¿›è¡Œlogisticå›å½’
### logisticå›å½’æ¨¡å‹å›é¡¾
åœ¨ç»Ÿè®¡ä¸­ï¼Œlogisticå›å½’(æˆ–logitå›å½’)æ˜¯ä¸€ç§æ¦‚ç‡åˆ†ç±»æ¨¡å‹ï¼ŒLogisticå›å½’å·²åœ¨åŒ…æ‹¬åŒ»å­¦å’Œç¤¾ä¼šç§‘å­¦é¢†åŸŸåœ¨å†…çš„è®¸å¤šå­¦ç§‘ä¸­å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚
logisticå›å½’åˆ†ä¸ºäºŒåˆ†ç±»logisticå›å½’å’Œå¤šåˆ†ç±»logisticå›å½’ï¼ŒäºŒåˆ†ç±»logisticå›å½’çš„å› å˜é‡çš„ç»“æœå…·æœ‰ä¸¤ç§å¯èƒ½çš„ç±»å‹ï¼Œå¤šåˆ†ç±»logisticå›å½’å› å˜é‡çš„ç»“æœå…·æœ‰ä¸‰ç§æˆ–å¤šç§å¯èƒ½çš„ç±»å‹ã€‚logisticå›å½’å¯ä»¥é€šè¿‡æ„å»ºlogisticå‡½æ•°æ¥å®ç°ã€‚

ä»¥äºŒåˆ†ç±»logisticå›å½’ä¸ºä¾‹ï¼Œlogitæ¨¡å‹ä¸€èˆ¬å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼š$$P_i=\frac{1}{1+\exp(-(\beta_1+\beta_2X_i))}$$
ä¹Ÿå¯ä»¥å°†å…¶å†™ä¸ºï¼š$$\log \frac{P_i}{1-P_i} = \beta_1+\beta_2X_i$$
å…¶ä¸­$P_i/(1-P_i)$ä¹Ÿè¢«ç§°ä¸ºä¼˜åŠ¿æ¯”(odds ratio)ã€‚
logisticå›å½’ä¸æ™®é€šçº¿æ€§å›å½’çš„æ˜¾è‘—åŒºåˆ«æ˜¯ä¸èƒ½é€šè¿‡è§£æè§£å¯¹å…¶æ¨¡å‹ä¸­çš„å¾…ä¼°ç³»æ•°ä½œå‡ºä¼°è®¡ï¼Œåªèƒ½é‡‡ç”¨ç‰›é¡¿è¿­ä»£ç­‰è¿­ä»£æ–¹æ³•æ±‚å‡ºå¾…ä¼°ç³»æ•°ã€‚åœ¨ä¼ ç»Ÿç»Ÿè®¡æ–¹æ³•ä¸­ï¼Œå¯ä»¥ä½¿ç”¨Rä¸­çš„`glm()`å‡½æ•°æˆ–Pythonä¸­çš„`sklearn.linear_model.LogisticRegression()`å‡½æ•°è½»æ¾åœ°å¯¹logisticå›å½’æ¨¡å‹çš„å¾…ä¼°ç³»æ•°è¿›è¡Œä¼°ç®—ã€‚ä½†æ˜¯å¯¹äºå¤§é‡æ•°æ®çš„logisticå›å½’å¤„ç†è€Œè¨€å­˜åœ¨ä¸€å®šå›°éš¾ã€‚é¦–å…ˆï¼Œç”±äºlogisticå›å½’æ¨¡å‹çš„å¾…ä¼°ç³»æ•°ä¸å…·æœ‰è§£æè§£ï¼Œçº¿æ€§å›å½’çš„MapReduceå®ç°æ–¹æ³•ä¸èƒ½ç”¨äºè§£å†³logisticå›å½’é—®é¢˜ï¼Œè€Œéœ€è¦å¤§é‡æ•°æ®äº¤æ¢çš„ç‰›é¡¿è¿­ä»£ç­‰è¿­ä»£è¿‡ç¨‹å¯¹MapReduceè€Œè¨€æ˜¯ä¸å®¹æ˜“å®ç°çš„ã€‚
Logisticå›å½’åœ¨æ ‡å‡†è¡Œä¸šå†…éå¸¸é‡è¦ï¼Œæ˜¯è®¸å¤šç”Ÿäº§æ¬ºè¯ˆæ£€æµ‹ï¼Œå¹¿å‘Šè´¨é‡å’Œé’ˆå¯¹æ€§äº§å“æ£€éªŒçš„åŸºç¡€ï¼Œç›®å‰ä¼ä¸šå¤„ç†Logisticå›å½’æœ€å¸¸è§çš„å®ç°æ–¹å¼æ˜¯å¯¹æ‰€æœ‰è¦ä½¿ç”¨çš„å¤§å‹è®­ç»ƒé›†ä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰ï¼Œè¿™ç§æ–¹æ³•å¤„ç†é€Ÿåº¦éå¸¸å¿«ï¼Œé€‚åˆåº”ç”¨äºå¤§å‹æ•°æ®çš„å¤„ç†ã€‚ä½†æ˜¯ï¼Œç›®å‰ä¼ä¸šå‡ ä¹ä¸ä¼šä½¿ç”¨Hadoopè¿›è¡ŒLogisticå›å½’å¤„ç†ï¼Œå¤§å¤šæ•°ä¼ä¸šä¼šä½¿ç”¨sparkç­‰æ›´é«˜çº§çš„å¹³å°ï¼Œåœ¨è¿™äº›æ›´é«˜çº§çš„å¹³å°ä¸Šå¤„ç†Logisticå›å½’è·å¾—çš„ç»“æœä¸ä¼ ç»Ÿå•æœºæ–¹å¼èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ã€‚

### logisticå›å½’æ¨¡å‹çš„MapReduceå®ç°åŸç†
ç”±äºä½¿ç”¨MapReduceå¯¹logisticå›å½’è¿›è¡Œå¤„ç†å­˜åœ¨ä¸€å®šå›°éš¾ï¼Œåœ¨ä½¿ç”¨MapReduceè¿›è¡Œç›¸å…³è®¡ç®—æ—¶å°±è¦è¿›è¡Œä¸€å®šçš„å–èˆï¼Œé€šè¿‡èˆå¼ƒä¸€éƒ¨åˆ†ç²¾ç¡®åº¦æ±‚å¾—å¾…ä¼°ç³»æ•°è¿‘ä¼¼çš„ä¼°è®¡å€¼ã€‚

ä½¿ç”¨MapReduceè¿›è¡Œlogisticå›å½’æ¨¡å‹å¤„ç†æ—¶ï¼Œé¦–å…ˆä»ä¼šå°†ğ‘›ä¸ªæ ·æœ¬åˆ’åˆ†ä¸ºğ‘˜ä¸ªå—ï¼Œæ¯ä¸ªå—ç”±ğ‘šä¸ªè§‚æµ‹å€¼ç»„æˆï¼Œæ¯ä¸€ä¸ªæ•°æ®å—ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¡ç®—å¤„ç†ã€‚
åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¯¹èŠ‚ç‚¹ä¸­çš„æ•°æ®å—è¿›è¡Œlogisticå›å½’ï¼Œä½¿ç”¨Ræˆ–Pythonçš„ç›¸å…³å‡½æ•°å¾ˆå®¹æ˜“å®ç°è¿™ä¸€è¿‡ç¨‹ã€‚å¾…ä¼°ç³»æ•°$\widehat \beta_l$çš„ä¼°è®¡è¡¨è¾¾å¼å¯å†™ä¸ºï¼š$$\widehat \beta_l = \arg~\max \sum _{i =1}^m \{ y_{li}x_{li}'\beta-\log(1+\exp\{x_i'\beta\})\}.$$
è·å¾—æ¯ä¸ªèŠ‚ç‚¹logisticå›å½’å¤„ç†ç»“æœåï¼Œå°†å¾—åˆ°çš„å„ä¸ª$\widehat \beta_l$ç»“æœè¿›è¡Œå¹³å‡å¯è·å¾—æ•´ä¸ªlogisticå›å½’çš„å¾…ä¼°ç³»æ•°$\widehat \beta$çš„ä¼°è®¡å€¼ï¼š$$\widehat \beta = \frac{1}{k}\sum_{l=1}^k \widehat \beta_l.$$
å¯ä»¥è¯æ˜ï¼Œå½“æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œä½¿ç”¨$\widehat \beta_l$çš„å¹³å‡å€¼è·å¾—çš„$\widehat \beta$çš„ä¼°è®¡å€¼æ˜¯éå¸¸æ¥è¿‘å•æœºç‰›é¡¿è¿­ä»£ç­‰æ–¹æ³•è®¡ç®—å‡ºçš„ä¼°è®¡å€¼çš„ã€‚

ä½¿ç”¨ä¸Šè¿°æ–¹æ³•è¿›è¡Œlogisticå›å½’æ˜¯å­˜åœ¨ä¸€å®šçš„åŠ£åŠ¿çš„ã€‚é¦–å…ˆï¼Œä¸Šè¿°æ–¹æ³•å¾—åˆ°çš„ä¼°è®¡å€¼çš„æ–¹å·®è¡¨è¾¾å¼ä¸ºï¼š$$Var(\widehat \beta)=\frac{1}{k^2}\sum_{l=1}^k{Var(\widehat \beta_l)}$$
åªè¦å•ä¸ªèŠ‚ç‚¹çš„æ–¹å·®çš„å¢åŠ é€Ÿåº¦æ¯”$k^2$å¿«ï¼Œé‚£ä¹ˆæ•´ä½“çš„æ–¹å·®ä¼šéšç€$k$çš„å¢åŠ è€Œå˜å¤§ï¼Œä¼°è®¡ç»“æœçš„å‡†ç¡®æ€§ä¼šå—åˆ°å½±å“ã€‚å…¶æ¬¡ï¼Œ$\widehat \beta$çš„ä¼°è®¡å€¼ä¼šå—åˆ°$k$å–å€¼çš„å½±å“ï¼Œ$k$å–ä¸åŒå€¼æ—¶æ‰€ä¼°è®¡çš„ç»“æœä¼šä¸åŒã€‚


